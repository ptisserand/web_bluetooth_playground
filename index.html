<html>
    <head>
        <script>
            var connected = false;
            var services_discovered = false;
            var selected_device;
            var connected_server;

            // presence of services of characteristics
            var has_device_service = false;
            var has_frame_data = false;            
            var has_info_data = false;

            // characteristic UUIDs
            DEVICE_SERVICE = '0000f00d-0000-1000-8000-00805f9b34fb';
            FRAME_UUID = '0000accc-1212-efde-1523-785fef13d123';            
            INFO_UUID = '0000accb-1212-efde-1523-785fef13d123';

            // cached characteristics
            var frame_data;
            var info_data;

            function setConnectedStatus(status) {
                connected = status;
                document.getElementById('status_connected').innerHTML = status;
                if (status == true) {
                    document.getElementById('btn_scan').innerHTML = "Disconnect";
                } else {
                    document.getElementById('btn_scan').innerHTML = "Discover Devices";
                }
            }

            function setDiscoveryStatus(status) {
                services_discovered = status;
                document.getElementById('status_discovered').innerHTML = status;
            }

            function discoverDevicesOrDisconnect() {
                console.log("discoverDevicesOrDisconnect");
                if (!connected) {
                    discoverDevices();
                } else {
                    selected_device.gatt.disconnect();
                    resetUI();
                }

            }
            function discoverDevices() {
                console.log("discoverDevices");

                var options = {
                    filters: [ {namePrefix: 'Panda'}],
                    // optionalServices: [DEVICE_SERVICE],
                }

                navigator.bluetooth.requestDevice(options)
                .then(device => {
                    console.log('> Name:      ' + device.name);
                    console.log('> Id:        ' + device.id);
                    console.log('> Connected: ' + device.gatt.connected);
                    selected_device = device;
                    console.log(selected_device);
                    connect();
                })
                .catch(error => {
                    alert('ERROR: ' + error);
                    console.log('ERROR : ' + error);
                })
            }
            function readInfo() {
                console.log("readInfo");
            }
            function toogleSensorNotifications() {
                console.log("toggleSensorNotifications");
            }

            function discoverSvcsAndChars() {
                console.log("discoverSvcsAndChars server=" + connected_server);
                connected_server.getPrimaryServices()
                    .then(services => {
                        has_device_service = false;

                        services_discovered = 0;
                        service_count = services.length;
                        console.log("Got " + service_count + " services");

                        services.forEach(service => {
                            if (service.uuid == DEVICE_SERVICE) {
                                has_device_service = true;
                            }
                            console.log('Getting Characteristics for service ' + service.uuid);
                            service.getCharacteristics().then(characteristics => {
                                console.log('> Service: ' + service.uuid);
                                services_discovered++;
                                characteristics_discovered = 0;
                                characteristics_count = characteristics.length;
                                characteristics.forEach(characteristic => {
                                    characteristics_discovered++;
                                    console.log('>> Characteristic: ' + characteristic.uuid);
                                    if (characteristic.uuid == FRAME_UUID) {
                                        frame_data = characteristic;
                                        has_frame_data = true;
                                    }
                                    if (characteristic.uuid = INFO_UUID) {
                                        info_data = characteristic;
                                        has_info_data = true;
                                    }
                                    if (services_discovered == service_count && characteristics_discovered == characteristics_count) {
                                        console.log("FINISHED DISCOVERY");
                                        setDiscoveryStatus(true);
                                    }
                                })
                            })
                        })
                    })
            }
            function connect() {
                if (connected == false) {
                    console.log("connecting");
                    selected_device.gatt.connect().then(
                        function(server) {
                            console.log("Connected to " + server.device.id);
                            console.log("connected=" + server.connected);
                            setConnectedStatus(true);
                            connected_server = server;

                            selected_device.addEventListener(
                                'gattserverdisconnected',
                                onDisconnected);
                                discoverSvcsAndChars();
                        },
                        function (error) {
                            console.log("ERROR: could not connect - " + error);
                            alert("ERROR: could not connect - " + error);
                            setConnectedStatus(false);
                        }
                    );                                           
                }
            }

            function onDisconnected() {
                setConnectedStatus(false);
                setDiscoveryStatus(false);
                document.getElementById('device_info').innerHTML = "";
                document.getElementById('frame_data').innerHTML = "";
            }

            function resetUI() {
                setConnectedStatus(false);
                setDiscoveryStatus(false);
                document.getElementById('device_info').innerHTML = "";
                document.getElementById('frame_data').innerHTML = "";
            }
        </script>
    </head>

    <body>
        <h1>Web Bluetooth</h1>
        <h2>Status</h2>
        <table border="1">
            <tr>
                <td>
                    <b>Connected</b>
                </td>
                <td>
                    <b>Service Discovery Completed</b>
                </td>
                <td>
                    <b>Notifications</b>
                </td>
            </tr>
            <tr>
                <td id="status_connected">false</td>
                <td id="status_discovered">false</td>
                <td id="status_notifications">false</td>
            </tr>
        </table>
        <h2>Device Discovery and Connection</h2>
        <button id="btn_scan" onclick="discoverDevicesOrDisconnect()">Discover Devices</button>
        <hr>
        <h2>Reading and Writing</h2>
        <h3>Read Characteristic</h3>
        <button id="btn_readInfo" onclick="readInfo()">Read Info</button>
        <div id="device_info"></div>
        <h2>Notifications</h2>
        <button id="btn_notify" onclick="toogleSensorNotifications()">Toggle Notifications</button>
        <div id="frame_data"></div>
    </body>
</html>